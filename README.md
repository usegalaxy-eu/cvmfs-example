# CVMFS Setup Example

## Setup

```bash
# git clone --recursive https://github.com/usegalaxy-eu/cvmfs-example
# cd cvmfs-example
```

## Installation

```
# ansible-playbook -c localhost cvmfs_client.yml
```

This will print a lot of output, but it can mostly be ignored unless it fails.

```
PLAY [localhost] *******************************************************************
TASK [Gathering Facts] *************************************************************
ok: [localhost]
TASK [cvmfs : Configure CernVM yum repositories] ***********************************
ok: [localhost] => (item={u'description': u'CernVM packages', u'name': u'cernvm', u'baseurl': u'http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/$releasever/$basearch/'})
ok: [localhost] => (item={u'description': u'CernVM-FS extra config packages', u'name': u'cernvm-config', u'baseurl': u'http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs-config/EL/$releasever/$basearch/'})
TASK [cvmfs : Install CernVM yum key] **********************************************
...
```

Once that's done, CVMFS will be set up! It uses autofs for mounting, and should have installed + created an autofs mountpoint:

## Testing CVMFS

Check that the following file exists. Depending on your OS it might be `/etc/auto.master` as well.

```
# cat /etc/auto.master.d/cvmfs.autofs
# automatically generated by CernVM-FS
/cvmfs /etc/auto.cvmfs
```

If it doesn't, then run `cvmfs_config setup`. After which the following commands will work.
You can test the CVMFS client by exploring the cvmfs mounts:

```
# ls /cvmfs/data.galaxyproject.org/
byhand  managed
# ls /cvmfs/data.galaxyproject.org/byhand
AaegL1                       braFlo1  ce5      droAna2       felCat4                     jacJac1   musMus5                                    phiX                                    strPur2
AgamP3                       caeJap1  ce6      droAna3       felCat5                     lengths   musMus6                                    PhumU1                                  strPur3
ailMel1                      caeJap2  ce7      droEre1       fr1                         lMaj5     musMus7                                    ponAbe2                                 susScr1
...
# ls /cvmfs/data.galaxyproject.org/byhand/mm10
bowtie2_index  bowtie_index  bwa_index  bwa_index_v0.5.9-r16  bwa_index_v0.7.10-r789  chrom  liftOver  picard_index  sam_index  seq
```

The folders will not be listed in /cvmfs by default, you can see these by listing the configured repositories:

```
# cvmfs_config showconfig | grep CVMFS_REPOSITORY_NAME
CVMFS_REPOSITORY_NAME=test.galaxyproject.org
CVMFS_REPOSITORY_NAME=main.galaxyproject.org
CVMFS_REPOSITORY_NAME=data.galaxyproject.org
CVMFS_REPOSITORY_NAME=sandbox.galaxyproject.org
CVMFS_REPOSITORY_NAME=singularity.galaxyproject.org

# ls /cvmfs/main.galaxyproject.org
bin  config  deps  fontconfig  galaxy  migrated_tools  python  shed_tools  tags.txt  tmp  tool_data  var  venv
```

This will also tell you that we distribute Singularity containers by default. Have a look at `ls -l /cvmfs/singularity.galaxyproject.org/` to see more.


